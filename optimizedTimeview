WITH latest_month AS (
    SELECT rptmnth 
    FROM eom 
    WHERE rptenddt = (SELECT MAX(rptenddt) FROM eom)
)

SELECT
    t.rptdt,
    t.roid,
    a.type,

    -- Correct subcode logic
    CASE 
        WHEN t.code IN ('106','107','309','310','311','312','313','314','315','316','317','318','319') THEN t.subcode
        WHEN ec.type = 'S' AND t.subcode <= '500' AND m.roid IS NULL THEN '000'
        WHEN t.subcode > '500' THEN '000'
        WHEN tn.timecode = '770' THEN '613'
        WHEN ec.type = 'T' THEN tn.timecode
        ELSE t.subcode
    END AS subcode,

    -- cdname
    CASE 
        WHEN tn.timecode = '770' THEN 'LEAVE'
        WHEN t.subcode > '500' THEN 'Direct Time'
        WHEN ec.cdname IS NOT NULL THEN ec.cdname
        ELSE ec2.cdname
    END AS cdname,

    TO_NUMBER(t.hours) AS hours,

    -- ctrsdef
    CASE 
        WHEN tn.timecode = '770' THEN 13
        WHEN t.subcode > '500' THEN 1
        WHEN ec.ctrsdef IS NOT NULL THEN ec.ctrsdef
        ELSE ec2.ctrsdef
    END AS ctrsdef,

    -- timedef
    CASE 
        WHEN tn.timecode = '770' THEN 'O'
        WHEN t.subcode > '500' THEN 'T'
        WHEN ec.timedef IS NOT NULL THEN ec.timedef
        ELSE ec2.timedef
    END AS timedef,

    -- ctrsln
    CASE 
        WHEN tn.timecode = '770' THEN 55
        WHEN t.subcode > '500' THEN 0
        WHEN ec.ctrsln IS NOT NULL THEN ec.ctrsln
        ELSE ec2.ctrsln
    END AS ctrsln

FROM timetin t

LEFT JOIN entcode ec ON t.subcode = ec.code AND ec.type = 'S'
LEFT JOIN timenon tn ON t.roid = tn.roid AND t.timesid = tn.timesid
LEFT JOIN entcode ec2 ON tn.timecode = ec2.code AND ec2.type = 'T'
LEFT JOIN entmod m ON t.roid = m.roid AND t.timesid = m.emodsid AND m.type IN ('N','O','R','T','X','Y')
JOIN archiveinv a ON t.roid = a.roid

-- Final filter
WHERE a.month = (SELECT rptmnth FROM latest_month)
  AND (
      ec.active IN ('Y','C') OR ec2.active IN ('Y','C')
  )
