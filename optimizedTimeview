WITH latest_month AS (
    SELECT MAX(rptenddt) AS max_rptenddt FROM eom
),
latest_rptmnth AS (
    SELECT rptmnth 
    FROM eom 
    WHERE rptenddt = (SELECT max_rptenddt FROM latest_month)
)
SELECT 
    COALESCE(ti.rptdt, tn.rptdt) AS rptdt,
    COALESCE(ti.roid, tn.roid) AS roid,
    ai.type,
    -- CASE logic to determine subcode
    CASE 
        WHEN ti.subcode > '500' THEN '000'
        WHEN tn.timecode = '770' AND ec_t.ctrsdef = 0 THEN '613'
        WHEN ti.timedef <> 'D' AND em.roid IS NULL THEN '000'
        WHEN em.roid IS NULL AND ti.timedef = 'D' THEN '000'
        ELSE COALESCE(ti.subcode, tn.timecode)
    END AS subcode,
    
    -- CASE logic to determine cdname
    CASE 
        WHEN ti.subcode > '500' THEN 'Direct Time'
        WHEN tn.timecode = '770' AND ec_t.ctrsdef = 0 THEN 'LEAVE'
        ELSE COALESCE(ec_s.cdname, ec_t.cdname)
    END AS cdname,

    -- Hours with conversion where necessary
    CASE 
        WHEN tn.hours IS NOT NULL THEN TO_NUMBER(tn.hours)
        ELSE ti.hours
    END AS hours,

    -- CASE for ctrsdef
    CASE 
        WHEN ti.subcode > '500' THEN 1
        WHEN tn.timecode = '770' THEN 13
        WHEN em.roid IS NULL AND ti.timedef = 'D' THEN 1
        ELSE COALESCE(ec_s.ctrsdef, ec_t.ctrsdef)
    END AS ctrsdef,

    -- CASE for timedef
    CASE 
        WHEN ti.subcode > '500' THEN 'T'
        WHEN tn.timecode = '770' THEN 'O'
        WHEN em.roid IS NULL AND ti.timedef = 'D' THEN 'T'
        ELSE COALESCE(ec_s.timedef, ec_t.timedef)
    END AS timedef,

    -- CASE for ctrsln
    CASE 
        WHEN ti.subcode > '500' THEN 0
        WHEN tn.timecode = '770' THEN 55
        WHEN em.roid IS NULL AND ti.timedef = 'D' THEN 0
        ELSE COALESCE(ec_s.ctrsln, ec_t.ctrsln)
    END AS ctrsln

FROM archiveinv ai
LEFT JOIN timetin ti ON ai.roid = ti.roid 
    AND EXISTS (SELECT 1 FROM latest_rptmnth WHERE rptmnth = ai.month)
LEFT JOIN timenon tn ON ai.roid = tn.roid 
    AND EXISTS (SELECT 1 FROM latest_rptmnth WHERE rptmnth = ai.month)
LEFT JOIN entcode ec_s ON ti.subcode = ec_s.code AND ec_s.type = 'S' AND ec_s.code <= '500'
LEFT JOIN entcode ec_t ON tn.timecode = ec_t.code AND ec_t.type = 'T'
LEFT JOIN entmod em ON ti.roid = em.roid AND ti.timesid = em.emodsid 
    AND em.type IN ('N','O','R','T','X','Y')

WHERE 
    (
        (ti.subcode IS NOT NULL AND ec_s.active IN ('Y','C') AND ec_s.timedef IN ('D','T')
         AND ec_s.code NOT IN ('106','107','309','310','311','312','313','314','315','316','317','318','319') AND ai.area = 1)
        OR (ti.subcode > '500')
        OR (tn.timecode IS NOT NULL AND ec_t.active IN ('Y','C'))
    )
