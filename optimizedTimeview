WITH latest_month AS (
    SELECT rptmnth 
    FROM eom 
    WHERE rptenddt = (SELECT MAX(rptenddt) FROM eom)
)

SELECT
    t.rptdt,
    t.roid,
    a.type,

    -- üõ†Ô∏è Fixed subcode logic with proper handling of '000' and LEAVE
    CASE 
        WHEN t.timecode = '770' THEN '613'
        WHEN ec.type = 'S' AND t.subcode <= '500' AND m.roid IS NULL THEN '000'
        WHEN t.subcode > '500' THEN '000'
        WHEN ec.type = 'T' THEN t.timecode
        ELSE t.subcode
    END AS subcode,

    -- cdname logic
    CASE 
        WHEN t.timecode = '770' THEN 'LEAVE'
        WHEN t.subcode > '500' THEN 'Direct Time'
        WHEN ec.cdname IS NOT NULL THEN ec.cdname
        ELSE ec2.cdname
    END AS cdname,

    TO_NUMBER(t.hours) AS hours,

    -- ctrsdef logic
    CASE 
        WHEN t.timecode = '770' THEN 13
        WHEN t.subcode > '500' THEN 1
        WHEN ec.ctrsdef IS NOT NULL THEN ec.ctrsdef
        ELSE ec2.ctrsdef
    END AS ctrsdef,

    -- timedef logic
    CASE 
        WHEN t.timecode = '770' THEN 'O'
        WHEN t.subcode > '500' THEN 'T'
        WHEN ec.timedef IS NOT NULL THEN ec.timedef
        ELSE ec2.timedef
    END AS timedef,

    -- ctrsln logic
    CASE 
        WHEN t.timecode = '770' THEN 55
        WHEN t.subcode > '500' THEN 0
        WHEN ec.ctrsln IS NOT NULL THEN ec.ctrsln
        ELSE ec2.ctrsln
    END AS ctrsln

FROM timetin t

-- For subcode ‚â§ 500
LEFT JOIN entcode ec ON t.subcode = ec.code AND ec.type = 'S'

-- For timecode from timenon
LEFT JOIN timenon tn ON t.roid = tn.roid AND t.timesid = tn.timesid
LEFT JOIN entcode ec2 ON tn.timecode = ec2.code AND ec2.type = 'T'

-- entmod match
LEFT JOIN entmod m ON t.roid = m.roid AND t.timesid = m.emodsid AND m.type IN ('N','O','R','T','X','Y')

JOIN archiveinv a ON t.roid = a.roid

-- Filters
WHERE a.month = (SELECT rptmnth FROM latest_month)
  AND (
      -- include records with valid subcode/timecode info
      ec.code IS NOT NULL OR t.subcode > '500' OR t.timecode = '770' OR (ec2.ctrsdef IS NOT NULL AND ec2.ctrsdef <> 0)
  )
  AND (
      -- active either in entcode or entcode2
      ec.active IN ('Y','C') OR ec2.active IN ('Y','C')
  )
